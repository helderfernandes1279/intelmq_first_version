from intelmq.lib.bot import Bot, sys
from intelmq.lib.message import Event
import datetime

class malwaredomainsparser(Bot):

    def process(self):
        report = self.receive_message()
	domainslist=[]
	report=report.split('\r\n')
	if report:
		
            for line in report:
	       line=line.replace('\t\t','',1)
	       if not line.startswith('#'):
		  domainslist.append((line.replace('\t\t','\t')).split('\t'))
		  	
            parsed_domains=[]
	    
            for line in domainslist:
		event = Event()
		if len(line) > 3:
		   event.add('domain',line[0])
		   event.add('type',line[1])
		   event.add('feed_url',line[2])
		   tmpdate=line[3]
		   event.add('last_seen',datetime.datetime.strptime(tmpdate,'%Y%m%d').strftime('%Y-%m-%d'))
		   event.add('feed','malwaredomains')
		   parsed_domains.append(event)
            self.send_message(parsed_domains)
        self.acknowledge_message()
   

if __name__ == "__main__":
    bot = malwaredomainsparser(sys.argv[1])
    bot.start()
